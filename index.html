<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <meta http-equiv="X-UA-Compatible" content="IE=edge">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Document</title>
    <link rel="stylesheet" href="mi_css.css">
</head>

<body>
    <div id="normasCont">
        <div id="normas">
            <h1>Bienvenido al capturabloques</h1>
            <br><br>
            <h3>Instrucciones:</h3>
            <br>
            <p>Eres una bola azul y tienes que capturar los bloques rojos que te vienen desde el lado derecho.
                <br><br>
                Por cada cuadrado capturado sumas 1 punto y por cada cuadrado que llegue hasta el final y no captures se te restará 1 punto
            </p>
            <br><br><br>
            <h4>¿Cuantos segundos quieres jugar?</h4>
            <br>
            <div>
                <label for="segundos">Segundos:</label>
                <input type="number" name="segundos" id="segundos">
                <input type="button" value="Jugar" onclick="iniciar()">
            </div>
        </div>
    </div>
    <div id="juegoTerminado">
        <h2>Tiempo terminado</h2>
        <br>
        <h5>Tus 5 mejores puntuaciones</h5>
    </div>
    <div id="juego">
        <div id="puntosCont">Puntuacion: <span id="puntos">5</span></div>

        <div id="jugador" class="jugador"></div>
        <div id="contador">0</div>
    </div>
    <script>
        normasCont = document.getElementById("normasCont")
        let posicionJugador = { x: 100, y: 100 };
        juego = document.getElementById("juego")
        puntuacion = document.getElementById("puntos")
        contador = document.getElementById("contador")
        puntos = 0;
        puntosFinales = 0;

        function crearElemento() {
            const elemento = document.createElement('div');
            elemento.classList.add('elemento');
            elemento.borrado = false;
            elemento.style.position = 'absolute';
            elemento.style.top = `${Math.random() * (juego.offsetHeight - 30)}px`;
            elemento.style.left = `${juego.offsetWidth - 30}px`;
            juego.appendChild(elemento);
            movimientoCuadrado = setInterval(() => {
                const left = parseFloat(elemento.style.left);
                if (elemento.offsetLeft == 0 && !elemento.borrado) {
                    elemento.remove()
                    puntos -= 1
                    puntuacion.textContent = puntos
                    elemento.borrado = true
                } else {
                    elemento.style.left = `${left - 1}px`;
                }
            }, 1)
        }


        moviendoW = false
        moviendoS = false
        moviendoA = false
        moviendoD = false

        document.addEventListener('keydown', (evento) => {
            switch (evento.key) {
                case 'w':
                    if (!moviendoW) {
                        moviendoW = true
                        intervaloW = setInterval(() => {
                            if (posicionJugador.y == 0) {
                                clearInterval(intervaloW)
                                moviendoW = false;
                                return
                            }
                            posicionJugador.y -= 1;
                        }, 2);
                    }
                    break;
                case 's':
                    if (!moviendoS) {
                        moviendoS = true
                        intervaloS = setInterval(() => {
                            if (posicionJugador.y == juego.offsetHeight - 10) {
                                clearInterval(intervaloS)
                                moviendoS = false;
                                return
                            }
                            posicionJugador.y += 1;
                        }, 2);
                    }
                    break;
                case 'a':
                    if (!moviendoA) {
                        moviendoA = true
                        intervaloA = setInterval(() => {
                            if (posicionJugador.x == 0) {
                                clearInterval(intervaloA)
                                moviendoA = false;
                                return
                            }
                            posicionJugador.x -= 1;
                        }, 2);
                    }
                    break;
                case 'd':
                    if (!moviendoD) {
                        moviendoD = true
                        intervaloD = setInterval(() => {
                            if (posicionJugador.x == juego.offsetWidth - 10) {
                                clearInterval(intervaloD)
                                moviendoD = false;
                                return
                            }
                            posicionJugador.x += 1;
                        }, 2);
                    }
                    break;
            }
        });

        document.addEventListener('keyup', (evento) => {
            switch (evento.key) {
                case 'w':
                    clearInterval(intervaloW);
                    moviendoW = false
                    break;
                case 's':
                    clearInterval(intervaloS);
                    moviendoS = false
                    break;
                case 'a':
                    clearInterval(intervaloA);
                    moviendoA = false
                    break;
                case 'd':
                    clearInterval(intervaloD);
                    moviendoD = false
                    break;


            }
        })
        function actualizarJugador() {
            const jugador = document.getElementById('jugador');
            jugador.style.left = `${posicionJugador.x}px`;
            jugador.style.top = `${posicionJugador.y}px`;
        }
        function animar() {
            // ...
            actualizarJugador();
            detectarColisiones().then(elemento => {
                puntos += 1
                    puntuacion.textContent = puntos
                    elemento.borrado = true
                    elemento.remove();
            });
            animacion = requestAnimationFrame(animar);
        }
        function detectarColisiones() {
           return new Promise((resolve, reject) => {
             const jugador = document.getElementById('jugador');
            const radioJugador = jugador.offsetWidth / 2;
            const centroJugador = {
                x: posicionJugador.x + radioJugador,
                y: posicionJugador.y + radioJugador,
            };

            const elementos = document.querySelectorAll('.elemento');
            elementos.forEach((elemento) => {
                const radioElemento = elemento.offsetWidth / 2;
                const centroElemento = {
                    x: elemento.offsetLeft + radioElemento,
                    y: elemento.offsetTop + radioElemento,
                };

                const distancia = Math.sqrt(
                    Math.pow(centroJugador.x - centroElemento.x, 2) +
                    Math.pow(centroJugador.y - centroElemento.y, 2)
                );

                if (distancia < radioJugador + radioElemento) {
                    resolve(elemento);
                }
            });
           })
        }

        function iniciar(){
            segundosInt = document.getElementById("segundos").value
            contador.textContent = segundosInt
            normasCont.style.display = "none"
            puntuacion.textContent = 0
            posicionJugador = { x: 100, y: 100 }
            contadorFunc()
            animar()
            creandoElementos = setInterval(crearElemento, 1000)
        }

        function parar(){
            puntosFinales = puntos
            alert("conseguiste una puntuacion de: " + puntosFinales)
            clearInterval(creandoElementos)
            cancelAnimationFrame(animar)
        }
        function contadorFunc(){
            contInt = setInterval(()=>{
                tiempoRest = contador.textContent
                if(tiempoRest <= 0){
                    clearInterval(contInt)
                    parar();
                }else
                    contador.textContent = tiempoRest - 1
            }, 1000)
        }
    </script>        
</body>

</html>